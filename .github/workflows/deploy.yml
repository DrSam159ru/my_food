name: Deploy Foodgram to Production

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/foodgram-backend:latest

      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/foodgram-frontend:latest

      - name: Build and push nginx
        uses: docker/build-push-action@v6
        with:
          context: ./infra/nginx
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/foodgram-nginx:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy production files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "infra/"
          target: "/${{ secrets.SSH_USER }}/foodgram"

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            cd ${{ secrets.SSH_USER }}/foodgram
            
            echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ==="
            ls -la infra/
            ls -la infra/nginx/
            echo "‚úÖ –§–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞ –º–µ—Å—Ç–µ"
            
            echo "=== –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ==="
            docker compose -f infra/docker-compose.prod.yml down || true
            echo "‚úÖ –°—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            
            echo "=== –û—á–∏—Å—Ç–∫–∞ volumes —Å—Ç–∞—Ç–∏–∫–∏ (–∫—Ä–æ–º–µ –ë–î –∏ –º–µ–¥–∏–∞) ==="
            docker volume rm infra_frontend_static infra_backend_static 2>/dev/null || true
            echo "‚úÖ Volumes —Å—Ç–∞—Ç–∏–∫–∏ –æ—á–∏—â–µ–Ω—ã (media –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)"
            
            echo "=== –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–µ–∂–∏—Ö –æ–±—Ä–∞–∑–æ–≤ –∏–∑ Docker Hub ==="
            docker compose -f infra/docker-compose.prod.yml pull
            echo "‚úÖ –°–≤–µ–∂–∏–µ –æ–±—Ä–∞–∑—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
            
            echo "=== –ó–∞–ø—É—Å–∫ –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ==="
            docker compose -f infra/docker-compose.prod.yml up -d
            echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã"

            echo "=== –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (40 —Å–µ–∫) ==="
            sleep 40
            
            echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ==="
            docker compose -f infra/docker-compose.prod.yml ps
            echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã"
            
            echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏–∫–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (—á–µ—Ä–µ–∑ nginx-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä) ==="
            docker exec infra-nginx-1 ls -la /var/www/static/ > /dev/null 2>&1 && echo "‚úÖ –°—Ç–∞—Ç–∏–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –Ω–∞ –º–µ—Å—Ç–µ" || echo "‚ö†Ô∏è –°—Ç–∞—Ç–∏–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –Ω–µ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞"
            
            echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏–∫–∏ –±—ç–∫–µ–Ω–¥–∞ ==="
            docker exec infra-backend-1 ls -la /app/static/ > /dev/null 2>&1 && echo "‚úÖ –°—Ç–∞—Ç–∏–∫–∞ –±—ç–∫–µ–Ω–¥–∞ –Ω–∞ –º–µ—Å—Ç–µ" || echo "‚ö†Ô∏è –°—Ç–∞—Ç–∏–∫–∞ –±—ç–∫–µ–Ω–¥–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞"
            
            echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ–¥–∏–∞ –ø–∞–ø–æ–∫ ==="
            docker exec infra-backend-1 ls -la /app/media/ > /dev/null 2>&1 && echo "‚úÖ –ú–µ–¥–∏–∞ –ø–∞–ø–∫–∞ –≤ –±—ç–∫–µ–Ω–¥–µ —Å–æ–∑–¥–∞–Ω–∞" || echo "‚ö†Ô∏è –ú–µ–¥–∏–∞ –ø–∞–ø–∫–∞ –≤ –±—ç–∫–µ–Ω–¥–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
            docker exec infra-nginx-1 ls -la /var/www/media/ > /dev/null 2>&1 && echo "‚úÖ –ú–µ–¥–∏–∞ –ø–∞–ø–∫–∞ –≤ nginx —Å–æ–∑–¥–∞–Ω–∞" || echo "‚ö†Ô∏è –ú–µ–¥–∏–∞ –ø–∞–ø–∫–∞ –≤ nginx –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
            
            echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞ —á–µ—Ä–µ–∑ nginx ==="
            if curl -f http://localhost/ > /dev/null 2>&1; then
              echo "‚úÖ –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–Ω–∞"
            else
              echo "‚ùå –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞"
            fi
            
            echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ API —á–µ—Ä–µ–∑ nginx ==="
            if curl -f http://localhost/api/ > /dev/null 2>&1; then
              echo "‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω"
            else
              echo "‚ùå API –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω"
            fi
            
            echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ–¥–∏–∞ –º–∞—Ä—à—Ä—É—Ç–∞ ==="
            if curl -I http://localhost/media/ 2>/dev/null | head -n 1 | grep -qE "200|301|302"; then
              echo "‚úÖ –ú–µ–¥–∏–∞ –º–∞—Ä—à—Ä—É—Ç –æ—Ç–≤–µ—á–∞–µ—Ç"
            else
              echo "‚ö†Ô∏è –ú–µ–¥–∏–∞ –º–∞—Ä—à—Ä—É—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
            fi
            
            echo "=== –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–µ–¥–∏–∞ –ø–∞–ø–æ–∫ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) ==="
            docker exec infra-backend-1 mkdir -p /app/media/recipes/1 /app/media/recipes/2 /app/media/avatars/1 || echo "–ú–µ–¥–∏–∞ –ø–∞–ø–∫–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç"
            docker exec infra-nginx-1 mkdir -p /var/www/media/recipes/1 /var/www/media/recipes/2 /var/www/media/avatars/1 || echo "–ú–µ–¥–∏–∞ –ø–∞–ø–∫–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç"
            
            echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞ ==="
            docker exec infra-backend-1 chmod 755 /app/media/ /app/media/recipes/ /app/media/avatars/ 2>/dev/null || true
            docker exec infra-nginx-1 chmod 755 /var/www/media/ /var/www/media/recipes/ /var/www/media/avatars/ 2>/dev/null || true
            echo "‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞ –ø–∞–ø–∫–∞–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            
            echo "=== –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ==="
            docker compose -f infra/docker-compose.prod.yml ps
            
            echo ""
            echo "üéâ üöÄ –î–ï–ü–õ–û–ô –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù!"
            echo "üì± –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω: http://food-gram.hopto.org"
            echo "üíæ –ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –¥–µ–ø–ª–æ—è–º–∏"
            echo "‚ö° –°—Ç–∞—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"

      - name: Telegram notify
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üéâ Foodgram: –ø–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!
            
            üìä –°—Ç–∞—Ç—É—Å:
            ‚úÖ –°–∞–π—Ç: http://food-gram.hopto.org
            ‚úÖ –°—Ç–∞—Ç–∏–∫–∞: CSS/JS —Ñ–∞–π–ª—ã
            ‚úÖ API: –±—ç–∫–µ–Ω–¥ –¥–æ—Å—Ç—É–ø–µ–Ω  
            ‚úÖ –ú–µ–¥–∏–∞: –∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫ (—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –¥–µ–ø–ª–æ—è–º–∏)
            ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: —Ä–∞–±–æ—Ç–∞–µ—Ç
            
            üìù –î–µ—Ç–∞–ª–∏:
            –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
            –í–µ—Ç–∫–∞: ${{ github.ref_name }}
            –ê–≤—Ç–æ—Ä: ${{ github.actor }}
            –ö–æ–º–º–∏—Ç: ${{ github.event.head_commit.message }}
            
            üöÄ –ì–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!!!
